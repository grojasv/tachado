---
import Layout from '../layouts/Layout.astro';
import DevFooter from '../components/DevFooter.astro';
---

<Layout title="Tachado - Todo App">
	<div class="max-w-md mx-auto touch-pan-y">
		<!-- Header -->
		<header class="mb-3 md:mb-4">
			<div class="flex items-center justify-between">
				<div>
					<h1 class="title">Tachado</h1>
					<p class="text-gray-700 text-sm">Planea. Tacha. Respira. Otra vez üîÅ</p>
				</div>
			</div>
		</header>



		<!-- Live region for assistive tech announcements -->
		<div class="sr-only" aria-live="polite" id="a11yAnnouncer"></div>
		<!-- Toast -->
		<div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-20 z-50 px-3 py-2 rounded-xl bg-black/80 text-white text-xs opacity-0 pointer-events-none transition-opacity"></div>

		<!-- Todo Input -->
		<div class="card card-hover p-4 md:p-6 mb-6">
			<div class="flex items-center gap-3">
				<input 
					type="text" 
					placeholder="A√±ade una tarea..." 
					class="input"
					id="todoInput"
				>
				<button 
					class="btn-primary"
					id="addTodoBtn"
					aria-label="A√±adir tarea"
				>
					+
				</button>
			</div>
		</div>

		<!-- Active Todos -->
		<div class="card card-hover p-4 md:p-6 mb-6">
			<h2 class="text-lg font-semibold text-gray-800 mb-4">Pendientes</h2>
			<div id="activeTodos" class="space-y-3">
				<div id="activeSkeleton" class="skeleton h-12"></div>
			</div>
		</div>

		<!-- Completed Todos -->
		<div class="card card-hover p-4 md:p-6">
			<h2 class="text-lg font-semibold text-gray-700 mb-4">Tachados</h2>
			<div id="completedTodos" class="space-y-3">
				<div id="completedSkeleton" class="skeleton h-10 w-1/2"></div>
			</div>
		</div>
	</div>

	<!-- Development Footer -->
	<DevFooter />
</Layout>

<script>
	import { getOrCreateSessionId, updateUrlWithSession, generateShareableUrl, isValidSessionId } from '../lib/sessionManager.js';
	import { scheduleSaveTodos, loadTodosFromFirebase, setupTodosRealtimeListener } from '../lib/firebaseDataManager.js';
	
	const todoInput = document.getElementById('todoInput') as HTMLInputElement;
	const addTodoBtn = document.getElementById('addTodoBtn') as HTMLButtonElement;
	const activeTodos = document.getElementById('activeTodos') as HTMLDivElement;
	const completedTodos = document.getElementById('completedTodos') as HTMLDivElement;
	const shareBtn = document.getElementById('shareBtn') as HTMLButtonElement;
	const sessionLabelFooter = document.getElementById('sessionLabelFooter') as HTMLSpanElement;
	const shareLinkInput = document.getElementById('shareLinkInput') as HTMLInputElement;
	const announcer = document.getElementById('a11yAnnouncer') as HTMLDivElement;
	const toast = document.getElementById('toast') as HTMLDivElement;


	function showToast(message: string) { if (!toast) return; toast.textContent = message; toast.style.opacity = '1'; setTimeout(() => { toast.style.opacity = '0'; }, 1400); }
	function vibrate(ms: number) { if ('vibrate' in navigator) try { (navigator as any).vibrate(ms); } catch {} }
	function announce(msg: string) { if (announcer) announcer.textContent = msg; }

	let todos: TodoItem[] = [];
	let sessionId: string = '';
	let cleanupRealtime: Function | null = null;

	interface TodoItem { id: string; text: string; completed: boolean; createdAt: Date | number; order: number; }

	function setSession(id: string) { sessionId = id; updateUrlWithSession(sessionId); if (sessionLabelFooter) sessionLabelFooter.textContent = sessionId; }
	function ensureSessionId() { if (!isValidSessionId(sessionId)) { setSession(getOrCreateSessionId()); } }
	function updateShareLinkPreview() { if (shareLinkInput) shareLinkInput.value = generateShareableUrl(sessionId); }
	function generateId(): string { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

	function createTodoElement(todo: TodoItem): HTMLElement {
		// Base card element
		const todoElement = document.createElement('div');
		todoElement.className = 'todo-item card p-4 animate-pop border border-white/40 relative';
		todoElement.dataset.todoId = todo.id;
		const checkbox = document.createElement('input');
		checkbox.type = 'checkbox';
		checkbox.className = 'checkbox mr-4 flex-shrink-0';
		checkbox.checked = !!todo.completed;
		checkbox.addEventListener('change', () => toggleTodo(todo.id));
		const textSpan = document.createElement('span');
		textSpan.className = `todo-text ${todo.completed ? 'line-through text-gray-500' : 'text-gray-800'}`;
		textSpan.textContent = todo.text;
		const contentContainer = document.createElement('div');
		contentContainer.className = 'flex items-center w-full';
		contentContainer.appendChild(checkbox);
		contentContainer.appendChild(textSpan);
		const dragIndicator = document.createElement('div');
		dragIndicator.className = 'ml-auto opacity-30 hover:opacity-60 transition-opacity duration-200';
		dragIndicator.innerHTML = '‚ãÆ‚ãÆ';
		dragIndicator.style.fontSize = '0.8rem';
		dragIndicator.style.fontWeight = 'bold';
		dragIndicator.style.color = '#6B7280';
		contentContainer.appendChild(dragIndicator);
		todoElement.appendChild(contentContainer);

		// Only completed items get swipe-to-delete wrapper + visuals
		if (todo.completed) {
			const wrapper = document.createElement('div');
			wrapper.className = 'swipe-container';
			const bg = document.createElement('div');
			bg.className = 'swipe-bg';
			const iconLeft = document.createElement('div'); iconLeft.className = 'swipe-icon left'; iconLeft.textContent = 'üóëÔ∏è';
			const iconRight = document.createElement('div'); iconRight.className = 'swipe-icon right'; iconRight.textContent = 'üóëÔ∏è';
			bg.appendChild(iconLeft); bg.appendChild(iconRight);
			wrapper.appendChild(bg);
			wrapper.appendChild(todoElement);
			attachSwipeToDelete(wrapper, todoElement, iconLeft, iconRight, todo.id);
			return wrapper;
		}

		// Active items: plain card
		return todoElement;
	}

	function attachSwipeToDelete(wrapper: HTMLElement, el: HTMLElement, iconLeft: HTMLElement, iconRight: HTMLElement, todoId: string) {
		let startX = 0; let swiping = false; let dx = 0;
		const THRESH = 64; // px threshold
		wrapper.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; swiping = true; dx = 0; });
		wrapper.addEventListener('touchmove', (e) => {
			if (!swiping) return;
			dx = e.touches[0].clientX - startX;
			el.style.transform = `translateX(${dx}px)`;
			const alpha = Math.min(1, Math.abs(dx) / 120);
			iconLeft.style.opacity = dx > 0 ? String(alpha) : '0';
			iconRight.style.opacity = dx < 0 ? String(alpha) : '0';
		});
		wrapper.addEventListener('touchend', () => {
			swiping = false;
			if (Math.abs(dx) > THRESH) {
				el.style.transition = 'transform .2s ease, opacity .2s ease';
				el.style.transform = `translateX(${dx > 0 ? 200 : -200}px)`;
				el.style.opacity = '0';
				setTimeout(() => { performDeleteCompleted(todoId); }, 180);
				vibrate(12); showToast('Item deleted');
			} else {
				el.style.transition = 'transform .2s ease, opacity .2s ease';
				el.style.transform = 'translateX(0)'; el.style.opacity = '1';
				iconLeft.style.opacity = '0'; iconRight.style.opacity = '0';
			}
		});
	}

	function performDeleteCompleted(todoId: string) {
		const tIndex = todos.findIndex(t => t.id === todoId);
		if (tIndex === -1) return;
		if (!todos[tIndex].completed) return; // only delete completed
		todos.splice(tIndex, 1);
		renderTodos();
		scheduleSaveTodos(sessionId, todos);
	}

	function addTodo(text: string) {
		if (!text.trim()) return;
		const newTodo: TodoItem = { id: generateId(), text: text.trim(), completed: false, createdAt: Date.now(), order: todos.length };
		todos.push(newTodo);
		renderTodos();
		scheduleSaveTodos(sessionId, todos);
		announce('Tarea a√±adida');
		vibrate(10);
		todoInput.value = '';
	}
	function toggleTodo(todoId: string) {
		const todo = todos.find(t => t.id === todoId);
		if (!todo) return;
		todo.completed = !todo.completed;
		renderTodos();
		scheduleSaveTodos(sessionId, todos);
		announce('Tarea actualizada');
		vibrate(8);
	}

	function initializeSortable() {
		const SortableLib = (window as any).Sortable;
		if (!SortableLib) return;
		new SortableLib(activeTodos, { group: 'todos', animation: 200, ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', dragClass: 'sortable-drag', delay: 150, delayOnTouchOnly: true, touchStartThreshold: 5, onEnd: () => { updateTodoOrder(); vibrate(6); } });
		new SortableLib(completedTodos, { group: 'todos', animation: 200, ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', dragClass: 'sortable-drag', delay: 150, delayOnTouchOnly: true, touchStartThreshold: 5, onEnd: () => { updateTodoOrder(); vibrate(6); } });
	}

	function renderTodos() {
		activeTodos.innerHTML = '';
		completedTodos.innerHTML = '';
		const sortedTodos = [...todos].sort((a, b) => (a.order || 0) - (b.order || 0));
		sortedTodos.forEach(todo => {
			const el = createTodoElement(todo);
			if (todo.completed) completedTodos.appendChild(el); else activeTodos.appendChild(el);
		});
		const sk1 = document.getElementById('activeSkeleton'); const sk2 = document.getElementById('completedSkeleton'); if (sk1) sk1.remove(); if (sk2) sk2.remove();
		initializeSortable();
	}
	function updateTodoOrder() {
		const activeEls = activeTodos.querySelectorAll('.todo-item');
		const completedEls = completedTodos.querySelectorAll('.todo-item');
		activeEls.forEach((el, idx) => { const t = todos.find(x => x.id === (el as HTMLElement).dataset.todoId); if (t) t.order = idx; });
		completedEls.forEach((el, idx) => { const t = todos.find(x => x.id === (el as HTMLElement).dataset.todoId); if (t) t.order = activeEls.length + idx; });
		scheduleSaveTodos(sessionId, todos);
		announce('Orden actualizado');
	}
	function updateSessionLabel() { if (sessionLabelFooter) sessionLabelFooter.textContent = sessionId; }

	addTodoBtn.addEventListener('click', () => addTodo(todoInput.value));
	todoInput.addEventListener('keydown', (e) => { if ((e as KeyboardEvent).key === 'Enter') addTodo(todoInput.value); });

	if (shareBtn) {
		shareBtn.addEventListener('click', async () => {
			try { ensureSessionId(); const url = generateShareableUrl(sessionId); if (shareLinkInput) shareLinkInput.value = url; await navigator.clipboard.writeText(url); showToast('Link copied to clipboard'); }
			catch { showToast('No se pudo copiar. Mant√©n pulsado para seleccionar el enlace.'); }
		});
	}



	(async function init() {
		sessionId = getOrCreateSessionId();
		updateSessionLabel();
		updateShareLinkPreview();
		try { const remoteTodos = await loadTodosFromFirebase(sessionId); if (remoteTodos && remoteTodos.length) { todos = remoteTodos.map(t => ({ ...t, createdAt: t.createdAt ?? Date.now() })); } else { const saved = localStorage.getItem('tachado-todos'); if (saved) todos = JSON.parse(saved); } }
		catch { const saved = localStorage.getItem('tachado-todos'); if (saved) todos = JSON.parse(saved); }
		renderTodos();
		cleanupRealtime = setupTodosRealtimeListener(sessionId, (remoteTodos) => { todos = Array.isArray(remoteTodos) ? remoteTodos : remoteTodos || []; renderTodos(); });
	})();

	console.log('Tachado Phase 4/6: Firebase sync enabled, pull-to-refresh removed');
</script>
